name: Release Bindings

on:
  push:
    tags:
      - 'bindings-v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (without v prefix, e.g. 0.2.0)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (skip actual publishing)'
        required: false
        type: boolean
        default: true

permissions:
  contents: read
  id-token: write  # Required for npm OIDC trusted publishing

jobs:
  validate-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/bindings-v}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$'; then
            echo "Error: Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-suffix"
            exit 1
          fi

  test-bindings:
    needs: validate-version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Test Node.js bindings
        working-directory: bindings/nodejs
        run: |
          npm ci
          npm run build
          npm run lint

      - name: Test Python bindings
        working-directory: bindings/python
        run: |
          pip install -e ".[dev]"
          python -m mypy crumblecracker

  # Build npm platform packages (cc-helper binaries)
  build-npm-platform:
    needs: [validate-version, test-bindings]
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            npm_platform: linux-x64
          - os: ubuntu-24.04-arm
            goos: linux
            goarch: arm64
            npm_platform: linux-arm64
          - os: macos-latest
            goos: darwin
            goarch: arm64
            npm_platform: darwin-arm64
          - os: macos-13
            goos: darwin
            goarch: amd64
            npm_platform: darwin-x64
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Build cc-helper
        run: |
          mkdir -p bindings/nodejs/packages/${{ matrix.npm_platform }}/bin
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} go build -o bindings/nodejs/packages/${{ matrix.npm_platform }}/bin/cc-helper ./cmd/cc-helper

      - name: Codesign cc-helper (macOS)
        if: runner.os == 'macOS'
        run: |
          codesign --sign - --entitlements tools/entitlements.xml --force bindings/nodejs/packages/${{ matrix.npm_platform }}/bin/cc-helper

      - name: Update version
        working-directory: bindings/nodejs/packages/${{ matrix.npm_platform }}
        run: npm version ${{ needs.validate-version.outputs.version }} --no-git-tag-version

      - name: Publish platform package (dry run)
        if: ${{ inputs.dry_run == true }}
        working-directory: bindings/nodejs/packages/${{ matrix.npm_platform }}
        run: npm pack

      - name: Publish platform package
        if: ${{ inputs.dry_run != true }}
        working-directory: bindings/nodejs/packages/${{ matrix.npm_platform }}
        run: npm publish --access public --provenance

  # NPM main package (depends on platform packages)
  publish-npm:
    needs: [validate-version, test-bindings, build-npm-platform]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Update version in package.json and dependencies
        working-directory: bindings/nodejs
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          npm version $VERSION --no-git-tag-version
          # Update optionalDependencies to match
          npm pkg set optionalDependencies.@crumblecracker/cc-darwin-arm64=$VERSION
          npm pkg set optionalDependencies.@crumblecracker/cc-darwin-x64=$VERSION
          npm pkg set optionalDependencies.@crumblecracker/cc-linux-x64=$VERSION
          npm pkg set optionalDependencies.@crumblecracker/cc-linux-arm64=$VERSION

      - name: Install and build
        working-directory: bindings/nodejs
        run: |
          npm ci --ignore-scripts
          npm run build
        env:
          CC_NPM_PUBLISH: 1

      - name: Publish (dry run)
        if: ${{ inputs.dry_run == true }}
        working-directory: bindings/nodejs/dist
        run: npm pack

      - name: Publish with provenance
        if: ${{ inputs.dry_run != true }}
        working-directory: bindings/nodejs/dist
        run: npm publish --access public --provenance

  # Python wheel building (matrix)
  build-python-wheels:
    needs: [validate-version, test-bindings]
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            arch: x86_64
            platform_tag: manylinux_2_17_x86_64
          - os: ubuntu-24.04-arm
            arch: aarch64
            platform_tag: manylinux_2_17_aarch64
          - os: macos-latest
            arch: arm64
            platform_tag: macosx_11_0_arm64
          - os: macos-13
            arch: x86_64
            platform_tag: macosx_10_9_x86_64
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install build tools
        run: pip install build wheel

      - name: Build libcc shared library and cc-helper
        run: |
          if [ "${{ runner.os }}" = "macOS" ]; then
            go build -buildmode=c-shared -o bindings/python/crumblecracker/libcc.dylib ./bindings/c
            go build -o bindings/python/crumblecracker/cc-helper ./cmd/cc-helper
            codesign --sign - --entitlements tools/entitlements.xml --force bindings/python/crumblecracker/cc-helper
          else
            go build -buildmode=c-shared -o bindings/python/crumblecracker/libcc.so ./bindings/c
            go build -o bindings/python/crumblecracker/cc-helper ./cmd/cc-helper
          fi

      - name: Update version
        working-directory: bindings/python
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          sed -i.bak 's/version = ".*"/version = "'$VERSION'"/' pyproject.toml
          rm -f pyproject.toml.bak

      - name: Build wheel
        working-directory: bindings/python
        run: python -m build --wheel
        env:
          # Tag the wheel with the correct platform
          SETUPTOOLS_SCM_PRETEND_VERSION: ${{ needs.validate-version.outputs.version }}

      - name: Rename wheel with platform tag
        working-directory: bindings/python
        run: |
          # Rename any-platform wheel to platform-specific
          cd dist
          PLATFORM_TAG="${{ matrix.platform_tag }}"
          for f in *.whl; do
            if echo "$f" | grep -q "any"; then
              # Replace py3-none-any with cp312-cp312-<platform>
              newname=$(echo "$f" | sed "s/py3-none-any/cp312-cp312-${PLATFORM_TAG}/")
              mv "$f" "$newname"
            fi
          done
          ls -la

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheel-${{ matrix.os }}-${{ matrix.arch }}
          path: bindings/python/dist/*.whl

  # Publish all wheels to PyPI (using OIDC trusted publishing)
  publish-pypi:
    needs: [validate-version, build-python-wheels]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for PyPI OIDC trusted publishing
    steps:
      - uses: actions/checkout@v4

      - name: Download all wheel artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: wheel-*
          path: dist
          merge-multiple: true

      - name: List wheels
        run: ls -la dist/

      - name: Publish to PyPI (dry run)
        if: ${{ inputs.dry_run == true }}
        run: |
          echo "Dry run - would publish these wheels:"
          ls -la dist/

      - name: Publish to PyPI
        if: ${{ inputs.dry_run != true }}
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/

  # Rust publishing (using OIDC trusted publishing)
  publish-cargo:
    needs: [validate-version, test-bindings]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write  # Required for crates.io OIDC trusted publishing
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Update version
        working-directory: bindings/rust
        run: |
          VERSION="${{ needs.validate-version.outputs.version }}"
          sed -i 's/^version = ".*"/version = "'$VERSION'"/' Cargo.toml

      - name: Build libcc (required for cargo package verification)
        run: go build -buildmode=c-shared -o build/libcc.so ./bindings/c

      - name: Package verification (dry run)
        if: ${{ inputs.dry_run == true }}
        working-directory: bindings/rust
        run: |
          cargo package --list
        env:
          LIBCC_PATH: ${{ github.workspace }}/build/libcc.so

      - name: Get crates.io token
        if: ${{ inputs.dry_run != true }}
        uses: rust-lang/crates-io-auth-action@v1
        id: auth

      - name: Publish to crates.io
        if: ${{ inputs.dry_run != true }}
        working-directory: bindings/rust
        run: cargo publish --no-verify
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.auth.outputs.token }}
